====================================================================
             生産実績管理システム（JISSEKI）システム設計書
====================================================================

■ 1. システム概要
────────────────────────────────────────────────────────────────

システム名     : 生産実績管理システム（JISSEKI）
技術スタック   : Python Flask + MySQL + JavaScript + HTML/CSS
目的           : コンタクトレンズ製造工程の生産実績管理と品質分析
開発言語       : Python 3.x
Webフレームワーク : Flask
データベース   : MySQL
フロントエンド : HTML5, CSS3, JavaScript, Bootstrap, Chart.js

■ 2. システム構成
────────────────────────────────────────────────────────────────

┌─────────────────────────────────────────────────────────────────┐
│                      プレゼンテーション層                        │
├─────────────────────────────────────────────────────────────────┤
│ HTML/CSS/JavaScript │ Jinja2テンプレート │ Bootstrap UI        │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                       アプリケーション層                         │
├─────────────────────────────────────────────────────────────────┤
│ Flask Application │ Flask-Login認証 │ WTForms │ Blueprint        │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                         ルーティング層                           │
├─────────────────────────────────────────────────────────────────┤
│ routes.py │ ishida1_routes.py │ ishida2_routes.py │ analyse_routes.py │
│ upload_routes.py │ auth.py                                        │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                       データアクセス層                           │
├─────────────────────────────────────────────────────────────────┤
│ SQLAlchemy ORM │ models.py │ ishida_models.py                    │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                           データ層                               │
├─────────────────────────────────────────────────────────────────┤
│ MySQL データベース │ 生産実績テーブル │ マスタテーブル        │
└─────────────────────────────────────────────────────────────────┘

■ 3. 主要機能概要
────────────────────────────────────────────────────────────────

【3.1 認証・セキュリティ機能】
- ユーザー認証（Flask-Login）
- セッション管理（24時間有効期限）
- パスワード暗号化（Werkzeug）

【3.2 データ取込機能】
- CSV一括取込（複数工程対応）
- Shift-JISエンコーディング対応
- エラーハンドリング・重複チェック
- データ形式検証

【3.3 品質分析機能】
- 不良率分析（工程別・アイテム別・時系列）
- トレンド分析（不良発生傾向）
- 比較分析（期間比較・条件別比較）
- クロス集計分析（膜カット合格数の多次元分析）
- CSVデータ取込によるダッシュボード
- 月別分析（膜加工、スピンコート、ハードコート）

【3.4 進捗管理機能】
- 未完了管理（各工程の進捗状況）
- 工程進捗（R1注入→R2注入→離型→検査）
- アラート機能（遅延案件検出）

【3.5 検索・照会機能】
- 多条件検索（ロット番号、製品、期間等）
- エクスポート機能（CSV出力）

【3.6 特記事項管理機能】
- 特記事項データの登録・編集・削除
- 画像添付機能（カメラ撮影対応）
  - 画質選択（低・中・高）
  - ズーム機能（1.0x～3.0x）
  - 画像サイズ制限（5MB）
  - 画像プレビュー
- 多条件検索（ロットNo.、期間、入力者等）
- 画像の拡大表示・操作機能
  - モーダルウィンドウ表示
  - ズーム操作（拡大・縮小・リセット）
  - ドラッグ＆ドロップ移動

【3.6 画像管理機能】
- 画像ファイル保存（static/images/notes/）
- 画像ファイル命名規則（自動生成）
- 画像サイズ最適化
  - 高画質：1920x1080
  - 中画質：1280x720
  - 低画質：640x480
- 画像削除時の物理ファイル管理

■ 4. データベース設計
────────────────────────────────────────────────────────────────

【4.1 主要テーブル構成】

◆ PRD_RECORD（生産実績テーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ PRR_LOT_NO         │ VARCHAR(17)│ ロット番号（主キー）     │
│ PRR_PRD_ID         │ VARCHAR(5) │ 製品ID                   │
│ PRR_R1_IN_DATE     │ DATETIME   │ R1注入日                 │
│ PRR_R1_TANK        │ DECIMAL(2) │ R1重合槽                 │
│ PRR_R2_TANK        │ DECIMAL(2) │ R2重合槽                 │
│ PRR_MONO_BATCH     │ VARCHAR(10)│ モノマーバッチ           │
│ PRR_INJECT_QTY     │ DECIMAL(4) │ 注入数                   │
│ PRR_A_GRADE        │ DECIMAL(4) │ A品                      │
│ PRR_B_GRADE        │ DECIMAL(4) │ B品                      │
│ PRR_MONO_SYU       │ VARCHAR(1) │ モノマー種               │
│ [不良項目50項目以上]│ DECIMAL(4) │ 各種不良項目             │
└────────────────┴──────────┴─────────────────────────┘

◆ PRD_MST（製品マスタテーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ PRD_ID             │ VARCHAR(5) │ 製品ID（主キー）         │
│ PRD_KBN            │ DECIMAL(2) │ 商品分類                 │
│ PRD_TYP            │ VARCHAR(1) │ 識別ID                   │
│ PRD_NM             │ VARCHAR(60)│ 製品名                   │
│ PRD_COLOR          │ VARCHAR(20)│ 膜カラー                 │
│ PRD_PLY_DAYS       │ DECIMAL(2) │ 重合日数                 │
└────────────────┴──────────┴─────────────────────────┘

◆ FMC_DAT（膜カットデータテーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ FMC_ID             │ INTEGER    │ ID（主キー・自動採番）   │
│ FMC_CUT_DATE       │ DATETIME   │ カット日                 │
│ FMC_R1_INJ_DATE    │ DATETIME   │ R1注入日                 │
│ FMC_MONOMER        │ DECIMAL(2) │ モノマー                 │
│ FMC_INPUT_QTY      │ DECIMAL(4) │ 投入数                   │
│ FMC_GOOD_QTY       │ DECIMAL(4) │ 良品数                   │
│ FMC_PASS_QTY       │ DECIMAL(4) │ 合格数                   │
│ [カット不良7項目]  │ DECIMAL(4) │ カット不良項目           │
│ [洗浄不良7項目]    │ DECIMAL(4) │ 洗浄不良項目             │
└────────────────┴──────────┴─────────────────────────┘

◆ FMP_DAT（膜加工データテーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ FMP_ID             │ INTEGER    │ ID（主キー・自動採番）   │
│ FMP_INSP_DATE      │ DATETIME   │ 検査日                   │
│ FMP_PROC_DATE      │ DATETIME   │ 加工日                   │
│ FMP_COLOR          │ DECIMAL(2) │ 色                       │
│ FMP_PVA_LOT_NO     │ DECIMAL(10)│ PVAロットNo              │
│ FMP_FILM_CURVE     │ DECIMAL(2) │ 膜カーブ                 │
│ FMP_PROC_SHTS      │ DECIMAL(5) │ 加工枚数                 │
│ [一次不良8項目]    │ DECIMAL(5) │ 一次検査不良項目         │
│ FMP_PRM_GOOD_QTY   │ DECIMAL(5) │ 一次良品数               │
│ [二次不良5項目]    │ DECIMAL(5) │ 二次検査不良項目         │
│ FMP_GRADE_A        │ DECIMAL(5) │ A品                      │
│ FMP_GRADE_B        │ DECIMAL(5) │ B品                      │
│ FMP_GRADE_C        │ DECIMAL(5) │ C品                      │
└────────────────┴──────────┴─────────────────────────┘

◆ SPC_DAT（スピンコートデータテーブル）
┌────────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ SPC_ID             │ INTEGER    │ ID（主キー・自動採番）   │
│ SPC_COAT_DATE      │ DATETIME   │ コート日                 │
│ SPC_TYPE           │ DECIMAL(2) │ 種類                     │
│ SPC_MACHINE        │ DECIMAL(2) │ 機番                     │
│ SPC_SHEETS         │ DECIMAL(5) │ 枚数                     │
│ SPC_PRE_BLK_DUST   │ DECIMAL(5) │ 硬化前黒ブツ             │
│ SPC_PRE_WHT_DUST   │ DECIMAL(5) │ 硬化前白ブツ             │
│ SPC_PRE_EDGE_FAIL  │ DECIMAL(5) │ 硬化前エッジ不良         │
│ SPC_PRE_COAT_FAIL  │ DECIMAL(5) │ 硬化前コート不良         │
│ SPC_PRE_DARK_SPOT  │ DECIMAL(5) │ 硬化前暗部               │
│ SPC_PRE_SNAIL      │ DECIMAL(5) │ 硬化前カタツムリ         │
│ SPC_PRE_MIST       │ DECIMAL(5) │ 硬化前ミスト             │
│ SPC_PRE_WRINKLE    │ DECIMAL(5) │ 硬化前シワ               │
│ SPC_PRE_BRRL_BUB   │ DECIMAL(5) │ 硬化前バレル気泡         │
│ SPC_PRE_STICK      │ DECIMAL(5) │ 硬化前スティック         │
│ SPC_PRE_TRBL_FIL   │ DECIMAL(5) │ 硬化前トラブル膜         │
│ SPC_PRE_BASE_FIL   │ DECIMAL(5) │ 硬化前基材膜             │
│ SPC_PRE_GOOD_QTY   │ DECIMAL(5) │ 硬化前良品数             │
│ SPC_PST_SCRATCH    │ DECIMAL(5) │ 硬化後キズ               │
│ SPC_PST_COAT_FIL   │ DECIMAL(5) │ 硬化後コート不良         │
│ SPC_PST_SNAIL      │ DECIMAL(5) │ 硬化後カタツムリ         │
│ SPC_PST_DARK_SPOT  │ DECIMAL(5) │ 硬化後暗部               │
│ SPC_PST_WRINKLE    │ DECIMAL(5) │ 硬化後シワ               │
│ SPC_PST_BUBBLE     │ DECIMAL(5) │ 硬化後気泡               │
│ SPC_PST_EDGE_FAIL  │ DECIMAL(5) │ 硬化後エッジ不良         │
│ SPC_PST_WHT_DUST   │ DECIMAL(5) │ 硬化後白ブツ             │
│ SPC_PST_BLK_DUST   │ DECIMAL(5) │ 硬化後黒ブツ             │
│ SPC_PST_STICK      │ DECIMAL(5) │ 硬化後スティック         │
│ SPC_PST_PRM_STICK  │ DECIMAL(5) │ 硬化後プライマースティック│
│ SPC_PST_BASE_FAIL  │ DECIMAL(5) │ 硬化後基材不良           │
│ SPC_PST_OTHERS     │ DECIMAL(5) │ 硬化後その他             │
│ SPC_FNL_GD_QTY     │ DECIMAL(5) │ 最終良品数               │
└────────────────┴──────────┴─────────────────────────┘

◆ HDC_DAT（ハードコートデータテーブル）
┌────────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ HDC_ID             │ INTEGER    │ ID（主キー・自動採番）   │
│ HDC_COAT_DATE      │ DATETIME   │ コート日                 │
│ HDC_TYPE           │ VARCHAR(10)│ 種類                     │
│ HDC_COLOR          │ VARCHAR(5) │ 色                       │
│ HDC_COAT_CNT       │ FLOAT      │ コート数                 │
│ HDC_PRE_FOREIGN    │ FLOAT      │ 硬化前ブツ               │
│ HDC_PRE_DROP       │ FLOAT      │ 硬化前タレ               │
│ HDC_PRE_CHIP       │ FLOAT      │ 硬化前カケ               │
│ HDC_PRE_STREAK     │ FLOAT      │ 硬化前スジ               │
│ HDC_PRE_OTHERS     │ FLOAT      │ 硬化前その他             │
│ HDC_TRS_BASE_FAIL  │ FLOAT      │ 透過基材不良             │
│ HDC_TRS_FOREIGN    │ FLOAT      │ 透過ブツ                 │
│ HDC_TRS_INCL       │ FLOAT      │ 透過イブツ               │
│ HDC_TRS_SCRATCH    │ FLOAT      │ 透過キズ                 │
│ HDC_TRS_COAT_FAIL  │ FLOAT      │ 透過コート不良           │
│ HDC_TRS_DROP       │ FLOAT      │ 透過タレ                 │
│ HDC_TRS_STREAK     │ FLOAT      │ 透過スジ                 │
│ HDC_TRS_DIRT       │ FLOAT      │ 透過汚れ                 │
│ HDC_TRS_CHIP       │ FLOAT      │ 透過カケ                 │
│ HDC_PRJ_BASE       │ FLOAT      │ 投影基材                 │
│ HDC_PRJ_FOREIGN    │ FLOAT      │ 投影ブツ                 │
│ HDC_PRJ_DUST       │ FLOAT      │ 投影ごみ                 │
│ HDC_PRJ_SCRATCH    │ FLOAT      │ 投影キズ                 │
│ HDC_PRJ_DROP       │ FLOAT      │ 投影タレ                 │
│ HDC_PRJ_CHIP       │ FLOAT      │ 投影カケ                 │
│ HDC_PRJ_STREAK     │ FLOAT      │ 投影スジ                 │
│ HDC_PASS_QTY       │ FLOAT      │ 合格数                   │
└────────────────┴──────────┴─────────────────────────┘

◆ KBN_MST（区分マスタテーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ KBN_TYP            │ VARCHAR(2) │ 分類（主キー）           │
│ KBN_ID             │ VARCHAR(2) │ ID（主キー）             │
│ KBN_NM             │ VARCHAR(20)│ 名称                     │
└────────────────┴──────────┴─────────────────────────┘

◆ NOTE_DAT（特記事項データテーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ NOTE_ID            │ INTEGER    │ ID（主キー・自動採番）   │
│ NOTE_LOT_NO        │ VARCHAR(17)│ ロットNo                 │
│ NOTE_DATE          │ DATETIME   │ 入力日                   │
│ NOTE_USER          │ DECIMAL(4) │ 入力者                   │
│ NOTE_TITLE         │ VARCHAR(40)│ 項目名                   │
│ NOTE_CNTNT         │ VARCHAR(200)│ 内容                    │
│ NOTE_PATH          │ VARCHAR(255)│ 画像パス                │
└────────────────┴──────────┴─────────────────────────┘

◆ USERS（ユーザーテーブル）
┌────────────────┬──────────┬─────────────────────────┐
│ 項目名             │ データ型   │ 説明                     │
├────────────────┼──────────┼─────────────────────────┤
│ USER_ID            │ VARCHAR(20)│ ユーザーID（主キー）     │
│ USERNAME           │ VARCHAR(50)│ ユーザー名               │
│ PASSWORD           │ VARCHAR(255)│ パスワード（暗号化）    │
│ LAST_LOGIN         │ DATETIME   │ 最終ログイン             │
│ USER_FLG           │ DECIMAL(1) │ ユーザーフラグ           │
└────────────────┴──────────┴─────────────────────────┘

【4.2 テーブル関係】
- PRD_RECORD ←→ PRD_MST   （製品ID）
- PRD_RECORD ←→ MNO_MST   （モノマー種）
- NOTE_DAT ←→ WRK_MST     （入力者）
- 各データテーブルは独立構造

■ 5. セキュリティ設計
────────────────────────────────────────────────────────────────

【5.1 認証・認可】
- Flask-Login によるセッション管理
- Werkzeug による パスワードハッシュ化
- セッション有効期限：24時間
- ログイン必須画面への自動リダイレクト

【5.2 データ保護】
- SQLAlchemy ORM 使用（SQLインジェクション対策）
- Jinja2 テンプレート自動エスケープ（XSS対策）
- 入力データ検証・サニタイズ

【5.3 アクセス制御】
- 全画面ログイン認証必須（@login_required）
- セッション無効時の自動ログアウト
- 権限レベル管理（USER_FLG）

■ 6. 性能・運用設計
────────────────────────────────────────────────────────────────

【6.1 データベース最適化】
- 主キー・外部キーによるインデックス自動設定
- 検索頻度の高い項目への複合インデックス
- データベース接続プール
- クエリ実行計画最適化

【6.2 アプリケーション最適化】
- Ajax通信による非同期データ取得
- Chart.js による高速グラフ描画
- レスポンシブデザイン（モバイル対応）
- 静的ファイル最適化

【6.3 エラーハンドリング】
- ログ出力機能（app.log）
- エラー画面の提供
- データ処理例外の適切な処理
- ユーザー向けエラーメッセージ

【6.4 バックアップ・復旧】
- データベース定期バックアップ
- 設定ファイル環境別管理（.env）
- ログファイル管理・ローテーション

■ 7. API設計
────────────────────────────────────────────────────────────────

【7.1 API エンドポイント】
- REST形式でのデータ提供
- JSON形式でのレスポンス
- エラーレスポンスの統一
- 認証必須API

【7.2 主要API一覧】

◆ 分析系API
- /api/defect_data                     : 不良データ取得
- /api/mono_syu_defect_data           : モノマー種別不良データ
- /api/mono_syu_defect_detail_data    : モノマー種別不良詳細
- /api/high_defect_rate_data          : 高不良率データ
- /api/defect_by_item_data            : 不良項目別データ
- /api/mono_syu_slide_data            : モノマー種別スライドデータ
- /api/mono_syu_inspection            : モノマー種別検査データ

◆ 膜カット系API
- /api/fmc_defect_analysis            : 膜カット不良分析データ
- /api/fmc_defect_detail_data         : 膜カット不良詳細データ
- /api/fmc_monomer_summary            : 膜カットモノマー別集計
- /api/fmc_cross_table                : 膜カット合格数クロス集計

◆ 膜加工系API
- /api/fmp_defect_analysis            : 膜加工不良分析データ
- /api/fmp_defect_detail_data         : 膜加工不良詳細データ
- /api/fmp_defect_analysis_slide      : 膜加工スライドデータ
- /api/fmp_defect_monthly_data        : 膜加工月別データ

◆ スピンコート系API
- /api/spc_defect_detail_data         : SPC不良詳細データ
- /api/spc_type_analysis_data         : SPC種類別分析データ
- /api/spc_defect_monthly_data        : SPC月別データ

◆ ハードコート系API
- /api/hdc_defect_detail_data         : HDC不良詳細データ
- /api/hdc_type_analysis_data         : HDC種類別分析データ
- /api/hdc_defect_monthly_data        : HDC月別データ
- /api/hdc_spc_slide                  : HDC SPCスライドデータ

◆ カラー不良系API
- /api/color_trans_defects            : カラー不良データ
- /api/color_trans_defects_slide      : カラー不良スライドデータ

◆ その他API
- /api/info_data                      : お知らせデータ

【7.3 特記事項関連API】
- /note_dat_list              : 特記事項一覧取得
- /note_dat_detail/<note_id>  : 特記事項詳細取得
- /note_dat_input             : 特記事項新規登録
- /note_dat_edit/<note_id>    : 特記事項編集
- /note_dat_delete/<note_id>  : 特記事項削除

■ 8. ファイル構成
────────────────────────────────────────────────────────────────

JISSEKI/
├── app/
│   ├── __init__.py              # Flaskアプリケーション初期化
│   ├── config.py                # 設定ファイル
│   ├── models.py                # 基本データベースモデル定義
│   ├── ishida_models.py         # 石田関連モデル定義
│   ├── routes.py                # メインルーティング
│   ├── ishida1_routes.py        # 石田第一ルーティング
│   ├── ishida2_routes.py        # 石田第二ルーティング
│   ├── analyse_routes.py        # 分析系ルーティング
│   ├── upload_routes.py         # アップロード系ルーティング
│   ├── auth.py                  # 認証関連機能
│   ├── forms.py                 # フォーム定義
│   ├── templates/               # Jinja2テンプレートファイル
│   │   ├── base.html            # 基本レイアウト
│   │   ├── login.html           # ログイン画面
│   │   ├── [52画面のHTMLファイル]
│   │   └── ※月別分析画面含む
│   └── static/                  # 静的ファイル
│       ├── css/                 # スタイルシート
│       │   └── style.css
│       └── images/              # 画像ファイル
│           └── notes/           # 特記事項画像
├── document/                    # ドキュメント
│   ├── 画面一覧.txt             # 画面一覧
│   ├── システム設計書.txt       # システム設計書
│   ├── 画面詳細説明書.txt       # 画面詳細説明書
│   ├── 操作手順書.txt           # 操作手順書
│   └── README.txt               # README
├── sql/                         # SQLファイル
│   ├── CREATE_*.sql             # テーブル作成SQL
│   └── [12個のCREATE文]
├── .env                         # 環境設定
├── requirements.txt             # 依存パッケージ
├── run.py                       # アプリケーション起動
├── create_user.py               # ユーザー作成スクリプト
├── debug.py                     # デバッグ用スクリプト
├── index.cgi                    # CGIファイル
└── app.log                      # アプリケーションログ

■ 9. 月別分析機能詳細
────────────────────────────────────────────────────────────────

【9.1 実装済み月別分析画面】
- 膜加工データ（月別）           : /fmp_defect_monthly_analysis
- スピンコートデータ（月別）     : /spc_defect_monthly_analysis  
- ハードコートデータ（月別）     : /hdc_defect_monthly_analysis

【9.2 月別分析機能仕様】
- 月単位での集計（YYYY-MM形式）
- 期間設定ボタン（今年、昨年、今月、前月）
- フィルタリング機能（色、種類、ロット等）
- Chart.js による可視化（積み上げ棒グラフ）
- 一次・二次検査データ分析
- 不良率推移の月別トレンド表示
- CSV出力機能対応

====================================================================
作成日: 2025年6月（最終更新: 2025年6月27日）
システム: 生産実績管理システム（JISSEKI）
技術スタック: Python Flask + MySQL + JavaScript + HTML/CSS
==================================================================== 