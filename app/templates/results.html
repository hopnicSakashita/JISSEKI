{% extends 'base.html' %}

{% block content %}
<div class="results-container">
    <h2>R1・R2実績</h2>
    
    <!-- 検索フォーム -->
    <div class="search-form">
        <form method="GET" action="{{ url_for('main.results') }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="date_from">R1注入日（開始）:</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ request.args.get('date_from', '') }}">
                    </div>
                    <button id="today-button" class="btn btn-info m-1">今日</button>
                    <button id="yesterday-button" class="btn btn-info m-1">昨日</button>
                    <button id="this-month-button" class="btn btn-info m-1">今月</button>
                    <button id="last-month-button" class="btn btn-info m-1">前月</button>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="date_to">R1注入日（終了）:</label>
                        <input type="date" class="form-control" id="date_to" name="date_to"
                               value="{{ request.args.get('date_to', '') }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="date_from">R2注入日（開始）:</label>
                        <input type="date" class="form-control" id="date_from2" name="date_from2" 
                               value="{{ request.args.get('date_from2', '') }}">
                    </div>
                    <button id="today-button2" class="btn btn-info m-1">今日</button>
                    <button id="yesterday-button2" class="btn btn-info m-1">昨日</button>
                    <button id="this-month-button2" class="btn btn-info m-1">今月</button>
                    <button id="last-month-button2" class="btn btn-info m-1">前月</button>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="date_to">R2注入日（終了）:</label>
                        <input type="date" class="form-control" id="date_to2" name="date_to2"
                               value="{{ request.args.get('date_to2', '') }}">
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="injector">R1注入者:</label>
                        <select class="form-control" id="injector" name="injector">
                            <option value="">全ての項目</option>
                            {% for worker in workers %}
                                <option value="{{ worker.WRK_ID }}" {% if worker.WRK_ID == request.args.get('injector') %}selected{% endif %}>
                                    {{ worker.WRK_NM }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="injector2">R2注入者:</label>
                        <select class="form-control" id="injector2" name="injector2">
                            <option value="">全ての項目</option>
                            {% for worker in workers %}
                                <option value="{{ worker.WRK_ID }}" {% if worker.WRK_ID == request.args.get('injector') %}selected{% endif %}>
                                    {{ worker.WRK_NM }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">検索</button>
                    <a href="{{ url_for('main.results') }}" class="btn btn-secondary">リセット</a>
                </div>
            </div>
        </form>
    </div>

    <!-- 検索結果表示 -->
    {% if request.args.get('date_from') or request.args.get('date_to') or request.args.get('date_from2') or request.args.get('date_to2') or request.args.get('injector') or request.args.get('injector2') %}
        {% if performances %}
        <div class="search-results mt-4"  style="height: 600px; overflow: auto;">
            <div class="results-summary mb-3">
                検索結果: {{ performances|length }}件
            </div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th class="border">R1注入日</th>
                        <th class="border">ロット番号</th>
                        <th class="border">製品名</th>
                        <th class="border">モノマー種</th>
                        <th class="border">R1重合槽</th>
                        <th class="border">R2重合槽</th>
                        <th class="border">モノマーバッチ</th>
                        <th class="border">R1注入者</th>
                        <th class="border">R1注入数</th>
                        <th class="border">巻きミス</th>
                        <th class="border">R1泡(検品)</th>
                        <th class="border">カール(検品)</th>
                        <th class="border">膜浮き(検品)</th>
                        <th class="border">モレ</th>
                        <th class="border">膜ひっぱり</th>
                        <th class="border">膜不良(検品)</th>
                        <th class="border">R1良品数</th>
                        <th class="border">R2注入日</th>
                        <th class="border">R2注入者</th>
                        <th class="border">R2泡(離型)</th>
                        <th class="border">ワレ</th>
                        <th class="border">チギレ(離型)</th>
                        <th class="border">重合ワレ</th>
                        <th class="border">その他1</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in performances %}
                    <tr>
                        <td class="border">{{ record.PRR_R1_IN_DATE.strftime('%Y/%m/%d') }}</td>
                        <td class="border">{{ record.PRR_LOT_NO }}</td>
                        <td class="border">{{ record.prd_mst.PRD_NM if record.prd_mst else '不明' }}</td>
                        <td class="border">{{ record.mono_mst.MNO_NM if record.mono_mst else '不明' }}</td>
                        <td class="border">{{ record.PRR_R1_TANK if record.PRR_R1_TANK else '' }}</td>
                        <td class="border">{{ record.PRR_R2_TANK if record.PRR_R2_TANK else '' }}</td>
                        <td class="border">{{ record.PRR_MONO_BATCH if record.PRR_MONO_BATCH else '' }}</td>
                        <td class="border">{{ (workers | selectattr('WRK_ID', 'equalto', record.PRR_R1_INJECT) | first).WRK_NM if (workers | selectattr('WRK_ID', 'equalto', record.PRR_R1_INJECT) | first) else '不明' }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_INJECT_QTY) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_ROLL_MISS) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_R1_BUB_CHK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_CURL_INS) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_FILM_FLT_CK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_LEAK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_FILM_PULL) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_FILM_NG_CK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_R1_GOOD_CNT) }}</td>
                        <td class="border">{{ record.PRR_R2_DATE.strftime('%Y/%m/%d') if record.PRR_R2_DATE else '' }}</td>
                        <td class="border">{{ (workers | selectattr('WRK_ID', 'equalto', record.PRR_R2_INJECT) | first).WRK_NM if (workers | selectattr('WRK_ID', 'equalto', record.PRR_R2_INJECT) | first) else '不明' }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_R2_BUB_REK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_CRACK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_TEAR_RLS) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_POLY_CRK) }}</td>
                        <td class="text-right border">{{ "{:,}".format(record.PRR_OTHER_1) }}</td>
                        
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-data mt-4">
            <p>検索条件に一致するデータがありません。</p>
        </div>
        {% endif %}
    {% else %}
    <div class="initial-message mt-4">
        <p>検索条件を入力して「検索」ボタンをクリックしてください。</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style>
    .results-container {
        padding: 20px;
    }
    
    .search-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .results-table th, .results-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    
    .results-table th {
        background-color: #f5f5f5;
        text-align: center;
    }
    
    .text-right {
        text-align: right;
    }
    
    .no-data {
        text-align: center;
        color: #666;
    }
    
    .results-summary {
        font-weight: bold;
        color: #666;
    }
</style>
{% endblock %} 

{% block scripts %}
<script>
    document.getElementById('csv-import-time').textContent = '実績CSVインポート時間: {{ csv_import_time }}';
    
    document.getElementById('today-button').addEventListener('click', function(e) {
        e.preventDefault();
        const today = new Date();
        document.getElementById('date_from').value = formatDateForInput(today);
        document.getElementById('date_to').value = formatDateForInput(today);
    });

    document.getElementById('yesterday-button').addEventListener('click', function(e) {
        e.preventDefault();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('date_from').value = formatDateForInput(yesterday);
        document.getElementById('date_to').value = formatDateForInput(yesterday);
    });

    document.getElementById('this-month-button').addEventListener('click', function(e) {
        e.preventDefault();
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        document.getElementById('date_from').value = formatDateForInput(firstDay);
        document.getElementById('date_to').value = formatDateForInput(lastDay);
    });

    document.getElementById('last-month-button').addEventListener('click', function(e) {
        e.preventDefault();
        const now = new Date();
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
        const firstDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
        const lastDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
        document.getElementById('date_from').value = formatDateForInput(firstDay);
        document.getElementById('date_to').value = formatDateForInput(lastDay);
    });

    document.getElementById('today-button2').addEventListener('click', function(e) {
        e.preventDefault();
        const today = new Date();
        document.getElementById('date_from2').value = formatDateForInput(today);
        document.getElementById('date_to2').value = formatDateForInput(today);
    });

    document.getElementById('yesterday-button2').addEventListener('click', function(e) {
        e.preventDefault();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('date_from2').value = formatDateForInput(yesterday);
        document.getElementById('date_to2').value = formatDateForInput(yesterday);
    });

    document.getElementById('this-month-button2').addEventListener('click', function(e) {
        e.preventDefault();
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        document.getElementById('date_from2').value = formatDateForInput(firstDay);
        document.getElementById('date_to2').value = formatDateForInput(lastDay);
    }); 

    document.getElementById('last-month-button2').addEventListener('click', function(e) {
        e.preventDefault();
        const now = new Date();
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
        const firstDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);    
        const lastDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
        document.getElementById('date_from2').value = formatDateForInput(firstDay);
        document.getElementById('date_to2').value = formatDateForInput(lastDay);
    });

</script>
{% endblock %}
