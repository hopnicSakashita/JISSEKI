{% extends 'base.html' %}

{% block style %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 30px;
    }
    .filters {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .total-row {
        background-color: #e9ecef;
        font-weight: bold;
    }
    .defect-summary {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .defect-summary h3 {
        margin-bottom: 15px;
    }
    .defect-summary table {
        width: 100%;
        border-collapse: collapse;
    }
    .defect-summary th, .defect-summary td {
        padding: 8px;
        text-align: right;
        border: 1px solid #ddd;
    }
    .defect-summary th {
        background-color: #f2f2f2;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .period-summary {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .period-summary h3 {
        margin-bottom: 15px;
    }
    .period-summary table {
        width: 100%;
        border-collapse: collapse;
    }
    .period-summary th, .period-summary td {
        padding: 8px;
        text-align: right;
        border: 1px solid #ddd;
    }
    .period-summary th {
        background-color: #f2f2f2;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<h1>膜カット不良データ（月別）</h1>

<div class="filters">
    <h3>フィルター</h3>
    <div class="row">
        <div class="col-md-6">
            <label for="date-from">開始日:</label>
            <input type="date" id="date-from" class="form-control">
            <button id="this-year-button" class="btn btn-info m-1">今年</button>
            <button id="last-year-button" class="btn btn-info m-1">昨年</button>
            <button id="this-month-button" class="btn btn-info m-1">今月</button>
            <button id="last-month-button" class="btn btn-info m-1">前月</button>
        </div>
        <div class="col-md-6">
            <label for="date-to">終了日:</label>
            <input type="date" id="date-to" class="form-control">
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-3">
            <label for="monomer">モノマー:</label>
            <select id="monomer" class="form-control">
                <option value="">すべて</option>
                {% for m in monomers %}
                <option value="{{ m.KBN_ID }}">{{ m.KBN_NM }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="item">アイテム:</label>
            <select id="item" class="form-control">
                <option value="">すべて</option>
                {% for i in items %}
                <option value="{{ i.KBN_ID }}">{{ i.KBN_NM }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="color">色:</label>
            <select id="color" class="form-control">
                <option value="">すべて</option>
                {% for c in colors %}
                <option value="{{ c.KBN_ID }}">{{ c.KBN_NM }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="film_curve">膜カーブ:</label>
            <select id="film_curve" class="form-control">
                <option value="">すべて</option>
                {% for fc in film_curves %}
                <option value="{{ fc.KBN_ID }}">{{ fc.KBN_NM }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <button id="apply-filters" class="btn btn-primary">適用</button>
            <button id="reset-filters" class="btn btn-secondary">リセット</button>
        </div>
    </div>
</div>

<!-- 月別カット工程不良項目推移グラフ -->
<div class="chart-container">
    <canvas id="monthly-cut-defect-chart"></canvas>
</div>

<!-- 月別洗浄工程不良項目推移グラフ -->
<div class="chart-container">
    <canvas id="monthly-wash-defect-chart"></canvas>
</div>

<!-- 期間合計不良率グラフ -->
<div class="chart-container">
    <canvas id="period-total-chart"></canvas>
</div>

<!-- 月別カット工程不良詳細データテーブル -->
<div class="defect-summary">
    <h3>月別カット工程不良詳細データ（投入数基準）</h3>
    <div class="table-responsive">
        <table class="table table-bordered" id="monthly-cut-defect-table">
            <thead class="thead-dark">
                <tr>
                    <th>不良項目</th>
                    <!-- 月が動的に追加される -->
                </tr>
            </thead>
            <tbody>
                <!-- データはJavaScriptで動的に生成 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 月別洗浄工程不良詳細データテーブル -->
<div class="defect-summary">
    <h3>月別洗浄工程不良詳細データ（良品数基準）</h3>
    <div class="table-responsive">
        <table class="table table-bordered" id="monthly-wash-defect-table">
            <thead class="thead-dark">
                <tr>
                    <th>不良項目</th>
                    <!-- 月が動的に追加される -->
                </tr>
            </thead>
            <tbody>
                <!-- データはJavaScriptで動的に生成 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 期間合計データテーブル -->
<div class="period-summary">
    <h3>期間合計</h3>
    <div class="table-responsive">
        <table class="table table-bordered" id="period-total-table">
            <thead class="thead-dark">
                <tr>
                    <th>工程種別</th>
                    <th>不良項目</th>
                    <th>不良数</th>
                    <th>不良率</th>
                </tr>
            </thead>
            <tbody>
                <!-- データはJavaScriptで動的に生成 -->
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0 "></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let monthlyCutChart = null;
        let monthlyWashChart = null;
        let periodTotalChart = null;

        setupDateButtons();
        setupEventListeners();
        
        // 初期データ読み込み
        fetchMonthlyData();
        
        function setupDateButtons() {
            // 今年ボタン
            document.getElementById('this-year-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const startOfNextYear = new Date(now.getFullYear() + 1, 0, 1);
                document.getElementById('date-from').value = formatDateForInput(startOfYear);
                document.getElementById('date-to').value = formatDateForInput(startOfNextYear);
            });
            
            // 昨年ボタン
            document.getElementById('last-year-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const startOfLastYear = new Date(now.getFullYear() - 1, 0, 1);
                const startOfThisYear = new Date(now.getFullYear(), 0, 1);
                document.getElementById('date-from').value = formatDateForInput(startOfLastYear);
                document.getElementById('date-to').value = formatDateForInput(startOfThisYear);
            });
            
            // 今月ボタン
            document.getElementById('this-month-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                document.getElementById('date-from').value = formatDateForInput(firstDay);
                document.getElementById('date-to').value = formatDateForInput(lastDay);
            });
            
            // 前月ボタン
            document.getElementById('last-month-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                const firstDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
                const lastDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
                document.getElementById('date-from').value = formatDateForInput(firstDay);
                document.getElementById('date-to').value = formatDateForInput(lastDay);
            });
        }
        
        function setupEventListeners() {
            // フィルター適用
            document.getElementById('apply-filters').addEventListener('click', function() {
                fetchMonthlyData();
            });
            
            // フィルターリセット
            document.getElementById('reset-filters').addEventListener('click', function() {
                document.getElementById('date-from').value = '';
                document.getElementById('date-to').value = '';
                document.getElementById('monomer').value = '';
                document.getElementById('item').value = '';
                document.getElementById('color').value = '';
                document.getElementById('film_curve').value = '';
                fetchMonthlyData();
            });
        }
        
        function updateCutDefectSummary(data) {
            const tableBody = document.getElementById('monthly-cut-defect-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            const tableHeader = document.getElementById('monthly-cut-defect-table').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            while (tableHeader.childElementCount > 1) {
                tableHeader.removeChild(tableHeader.lastChild);
            }
            
            // 月をヘッダーに追加
            data.months.forEach(month => {
                const th = document.createElement('th');
                th.textContent = month;
                tableHeader.appendChild(th);
            });
            
            // カット工程不良項目ごとのデータを行として追加
            Object.entries(data.cut_defect_labels).forEach(([defect_type, label]) => {
                let hasData = false;
                data.months.forEach(month => {
                    if (data.cut_defect_data[month] && 
                        data.cut_defect_data[month][defect_type] !== undefined && 
                        data.cut_defect_data[month][defect_type].rate > 0) {
                        hasData = true;
                    }
                });
                
                if (!hasData) return;
                
                const row = document.createElement('tr');
                
                const typeCell = document.createElement('td');
                typeCell.textContent = label;
                row.appendChild(typeCell);
                
                data.months.forEach(month => {
                    const cell = document.createElement('td');
                    if (data.cut_defect_data[month] && data.cut_defect_data[month][defect_type] !== undefined) {
                        const rate = data.cut_defect_data[month][defect_type].rate;
                        cell.textContent = rate < 0.01 ? '0.00' : rate.toFixed(2);
                        cell.textContent += '%';
                    } else {
                        cell.textContent = '-';
                    }
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
            
            // 合計行の追加
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'カット工程合計';
            totalRow.appendChild(totalLabelCell);
            
            data.months.forEach(month => {
                const cell = document.createElement('td');
                if (data.cut_total_data[month] !== undefined) {
                    const rate = data.cut_total_data[month];
                    cell.textContent = rate < 0.01 ? '0.00' : rate.toFixed(2);
                    cell.textContent += '%';
                } else {
                    cell.textContent = '-';
                }
                totalRow.appendChild(cell);
            });
            
            tableBody.appendChild(totalRow);
        }
        
        function updateWashDefectSummary(data) {
            const tableBody = document.getElementById('monthly-wash-defect-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            const tableHeader = document.getElementById('monthly-wash-defect-table').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            while (tableHeader.childElementCount > 1) {
                tableHeader.removeChild(tableHeader.lastChild);
            }
            
            // 月をヘッダーに追加
            data.months.forEach(month => {
                const th = document.createElement('th');
                th.textContent = month;
                tableHeader.appendChild(th);
            });
            
            // 洗浄工程不良項目ごとのデータを行として追加
            Object.entries(data.wash_defect_labels).forEach(([defect_type, label]) => {
                let hasData = false;
                data.months.forEach(month => {
                    if (data.wash_defect_data[month] && 
                        data.wash_defect_data[month][defect_type] !== undefined && 
                        data.wash_defect_data[month][defect_type].rate > 0) {
                        hasData = true;
                    }
                });
                
                if (!hasData) return;
                
                const row = document.createElement('tr');
                
                const typeCell = document.createElement('td');
                typeCell.textContent = label;
                row.appendChild(typeCell);
                
                data.months.forEach(month => {
                    const cell = document.createElement('td');
                    if (data.wash_defect_data[month] && data.wash_defect_data[month][defect_type] !== undefined) {
                        const rate = data.wash_defect_data[month][defect_type].rate;
                        cell.textContent = rate < 0.01 ? '0.00' : rate.toFixed(2);
                        cell.textContent += '%';
                    } else {
                        cell.textContent = '-';
                    }
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
            
            // 合計行の追加
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = '洗浄工程合計';
            totalRow.appendChild(totalLabelCell);
            
            data.months.forEach(month => {
                const cell = document.createElement('td');
                if (data.wash_total_data[month] !== undefined) {
                    const rate = data.wash_total_data[month];
                    cell.textContent = rate < 0.01 ? '0.00' : rate.toFixed(2);
                    cell.textContent += '%';
                } else {
                    cell.textContent = '-';
                }
                totalRow.appendChild(cell);
            });
            
            tableBody.appendChild(totalRow);
        }
        
        function updatePeriodSummary(data) {
            const tableBody = document.getElementById('period-total-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            let totalInput = 0;
            let totalGood = 0;

            // 期間合計の計算
            data.months.forEach(month => {
                if (data.total_data[month]) {
                    totalInput += data.total_data[month].total_input;
                    totalGood += data.total_data[month].total_good;
                }
            });

            // カット工程の各不良項目の合計を計算
            Object.entries(data.cut_defect_labels).forEach(([defect_type, label]) => {
                let defectTotal = 0;
                data.months.forEach(month => {
                    if (data.cut_defect_data[month] && data.cut_defect_data[month][defect_type] !== undefined) {
                        defectTotal += data.cut_defect_data[month][defect_type].count;
                    }
                });

                if (defectTotal > 0) {
                    const row = document.createElement('tr');
                    
                    const processTypeCell = document.createElement('td');
                    processTypeCell.textContent = 'カット工程';
                    row.appendChild(processTypeCell);
                    
                    const typeCell = document.createElement('td');
                    typeCell.textContent = label;
                    row.appendChild(typeCell);

                    const countCell = document.createElement('td');
                    countCell.textContent = Math.round(defectTotal);
                    row.appendChild(countCell);

                    const rateCell = document.createElement('td');
                    const rate = totalInput > 0 ? (defectTotal / totalInput * 100) : 0;
                    rateCell.textContent = (rate < 0.01 ? '0.00' : rate.toFixed(2)) + '%';
                    row.appendChild(rateCell);

                    tableBody.appendChild(row);
                }
            });

            // 洗浄工程の各不良項目の合計を計算  
            Object.entries(data.wash_defect_labels).forEach(([defect_type, label]) => {
                let defectTotal = 0;
                data.months.forEach(month => {
                    if (data.wash_defect_data[month] && data.wash_defect_data[month][defect_type] !== undefined) {
                        defectTotal += data.wash_defect_data[month][defect_type].count;
                    }
                });

                if (defectTotal > 0) {
                    const row = document.createElement('tr');
                    
                    const processTypeCell = document.createElement('td');
                    processTypeCell.textContent = '洗浄工程';
                    row.appendChild(processTypeCell);
                    
                    const typeCell = document.createElement('td');
                    typeCell.textContent = label;
                    row.appendChild(typeCell);

                    const countCell = document.createElement('td');
                    countCell.textContent = Math.round(defectTotal);
                    row.appendChild(countCell);

                    const rateCell = document.createElement('td');
                    const rate = totalGood > 0 ? (defectTotal / totalGood * 100) : 0;
                    rateCell.textContent = (rate < 0.01 ? '0.00' : rate.toFixed(2)) + '%';
                    row.appendChild(rateCell);

                    tableBody.appendChild(row);
                }
            });
        }
        
        function updateCutChart(data) {
            const ctx = document.getElementById('monthly-cut-defect-chart').getContext('2d');
            
            if (monthlyCutChart) {
                monthlyCutChart.destroy();
            }
            
            // 有効な不良項目を抽出
            const validDefectTypes = [];
            Object.keys(data.cut_defect_labels).forEach(defect_type => {
                let hasData = false;
                data.months.forEach(month => {
                    if (data.cut_defect_data[month] && 
                        data.cut_defect_data[month][defect_type] !== undefined && 
                        data.cut_defect_data[month][defect_type].rate > 0) {
                        hasData = true;
                    }
                });
                if (hasData) {
                    validDefectTypes.push(defect_type);
                }
            });
            
            // データセットの作成
            const datasets = [];
            validDefectTypes.forEach((defect_type, index) => {
                datasets.push({
                    label: data.cut_defect_labels[defect_type],
                    data: data.months.map(month => {
                        if (data.cut_defect_data[month] && data.cut_defect_data[month][defect_type] !== undefined) {
                            return data.cut_defect_data[month][defect_type].rate;
                        }
                        return 0;
                    }),
                    backgroundColor: `hsl(${(index*60)%360},70%,70%)`,
                });
            });
            
            monthlyCutChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '月別カット工程不良項目の推移（投入数基準）',
                            font: { size: 18 }
                        },
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        const rate = context.parsed.y;
                                        label += (rate < 0.01 ? '0.00' : rate.toFixed(2)) + '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'start',
                            font: {
                                size: 10, 
                                weight: 'bold',
                                family: 'Meiryo',
                                color: '#ffffff'
                            },
                            formatter: function(value, context) {
                                return (value < 5 ? '' : (value.toFixed(2) + '%'));
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: { display: true, text: '月' },
                            ticks: { font: { size: 16 } }
                        },
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            title: { display: true, text: '不良率 (%)' },
                            ticks: { font: { size: 16 } }
                        }
                    }
                }
            });
        }
        
        function updateWashChart(data) {
            const ctx = document.getElementById('monthly-wash-defect-chart').getContext('2d');
            
            if (monthlyWashChart) {
                monthlyWashChart.destroy();
            }
            
            // 有効な不良項目を抽出
            const validDefectTypes = [];
            Object.keys(data.wash_defect_labels).forEach(defect_type => {
                let hasData = false;
                data.months.forEach(month => {
                    if (data.wash_defect_data[month] && 
                        data.wash_defect_data[month][defect_type] !== undefined && 
                        data.wash_defect_data[month][defect_type].rate > 0) {
                        hasData = true;
                    }
                });
                if (hasData) {
                    validDefectTypes.push(defect_type);
                }
            });
            
            // データセットの作成
            const datasets = [];
            validDefectTypes.forEach((defect_type, index) => {
                datasets.push({
                    label: data.wash_defect_labels[defect_type],
                    data: data.months.map(month => {
                        if (data.wash_defect_data[month] && data.wash_defect_data[month][defect_type] !== undefined) {
                            return data.wash_defect_data[month][defect_type].rate;
                        }
                        return 0;
                    }),
                    backgroundColor: `hsl(${(index*60+30)%360},70%,70%)`,
                });
            });
            
            monthlyWashChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '月別洗浄工程不良項目の推移（良品数基準）',
                            font: { size: 18 }
                        },
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        const rate = context.parsed.y;
                                        label += (rate < 0.01 ? '0.00' : rate.toFixed(2)) + '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'start',
                            font: {
                                size: 10, 
                                weight: 'bold',
                                family: 'Meiryo',
                                color: '#ffffff'
                            },
                            formatter: function(value, context) {
                                return (value < 5 ? '' : (value.toFixed(2) + '%'));
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: { display: true, text: '月' },
                            ticks: { font: { size: 16 } }
                        },
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            title: { display: true, text: '不良率 (%)' },
                            ticks: { font: { size: 16 } }
                        }
                    }
                }
            });
        }
        
        function updatePeriodTotalChart(data) {
            const ctx = document.getElementById('period-total-chart').getContext('2d');
            if (periodTotalChart) {
                periodTotalChart.destroy();
            }

            let totalInput = 0;
            let totalGood = 0;
            data.months.forEach(month => {
                if (data.total_data[month]) {
                    totalInput += data.total_data[month].total_input;
                    totalGood += data.total_data[month].total_good;
                }
            });

            // 不良データの計算と格納
            const defectItems = [];
            
            // カット工程不良項目
            Object.entries(data.cut_defect_labels).forEach(([defect_type, label]) => {
                let defectTotal = 0;
                data.months.forEach(month => {
                    if (data.cut_defect_data[month] && data.cut_defect_data[month][defect_type] !== undefined) {
                        defectTotal += data.cut_defect_data[month][defect_type].count;
                    }
                });

                if (defectTotal > 0) {
                    const rate = totalInput > 0 ? (defectTotal / totalInput * 100) : 0;
                    defectItems.push({
                        defect_type: defect_type,
                        label: `カット: ${label}`,
                        rate: rate,
                        color: `hsl(${defectItems.length*30%360},70%,70%)`
                    });
                }
            });

            // 洗浄工程不良項目
            Object.entries(data.wash_defect_labels).forEach(([defect_type, label]) => {
                let defectTotal = 0;
                data.months.forEach(month => {
                    if (data.wash_defect_data[month] && data.wash_defect_data[month][defect_type] !== undefined) {
                        defectTotal += data.wash_defect_data[month][defect_type].count;
                    }
                });

                if (defectTotal > 0) {
                    const rate = totalGood > 0 ? (defectTotal / totalGood * 100) : 0;
                    defectItems.push({
                        defect_type: defect_type,
                        label: `洗浄: ${label}`,
                        rate: rate,
                        color: `hsl(${defectItems.length*30%360},70%,70%)`
                    });
                }
            });

            // 不良率で降順ソート
            defectItems.sort((a, b) => b.rate - a.rate);

            periodTotalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: defectItems.map(item => item.label),
                    datasets: [{
                        label: '期間合計不良率',
                        data: defectItems.map(item => item.rate),
                        backgroundColor: defectItems.map(item => item.color),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '期間合計不良率',
                            font: { size: 18 }
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const rate = context.parsed.y;
                                    return `不良率: ${rate < 0.01 ? '0.00' : rate.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: '不良項目',
                                font: { size: 14 }
                            },
                            ticks: { 
                                font: { size: 12 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: '不良率 (%)',
                                font: { size: 14 }
                            },
                            ticks: { 
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }
        
        function fetchMonthlyData() {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const monomer = document.getElementById('monomer').value;
            const item = document.getElementById('item').value;
            const color = document.getElementById('color').value;
            const filmCurve = document.getElementById('film_curve').value;
            
            let url = '/api/fmc_defect_monthly_data?';
            if (dateFrom) url += `start_date=${encodeURIComponent(dateFrom)}&`;
            if (dateTo) url += `end_date=${encodeURIComponent(dateTo)}&`;
            if (monomer) url += `monomer=${encodeURIComponent(monomer)}&`;
            if (item) url += `item=${encodeURIComponent(item)}&`;
            if (color) url += `color=${encodeURIComponent(color)}&`;
            if (filmCurve) url += `film_curve=${encodeURIComponent(filmCurve)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    updateCutChart(data);
                    updateWashChart(data);
                    updateCutDefectSummary(data);
                    updateWashDefectSummary(data);
                    updatePeriodSummary(data);
                    updatePeriodTotalChart(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
    });
</script>
{% endblock %} 