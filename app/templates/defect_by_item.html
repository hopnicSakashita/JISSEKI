{% extends 'base.html' %}

{% block style %}
<style>
    .chart-container {
        position: relative;
        height: 600px;
        width: 100%;
        margin-bottom: 30px;
    }
    
    .table-container {
        margin-top: 30px;
        overflow-x: auto;
    }
    
    .defect-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .defect-table th, .defect-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: right;
    }
    
    .defect-table th {
        background-color: #f2f2f2;
        text-align: center;
    }
    
    .defect-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .filters {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .over-target {
        color: red;
        font-weight: bold;
    }
    
    .total-row {
        background-color: #e9ecef;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<h1>不良項目別モノマー種毎の不良率分析</h1>

<div class="filters">
    <h3>フィルター</h3>
    <div class="row">
        <div class="col-md-6">
            <label for="defect-item">不良項目:</label>
            <select id="defect-item" class="form-control">
                <option value="">選択してください</option>
                <option value="roll_miss">巻きミス</option>
                <option value="leak">モレ</option>
                <option value="film_pull">膜ひっぱり</option>
                <option value="crack">ワレ</option>
                <option value="tear">チギレ</option>
                <option value="peel">ハガレ</option>
                <option value="chip">カケ</option>
                <option value="poly_crk">重合ワレ</option>
                <option value="mold_scr">型キズ</option>
                <option value="lens_scr">レンズキズ</option>
                <option value="r1_bubble">R1泡</option>
                <option value="r2_bubble">R2泡</option>
                <option value="defect">ブツ</option>
                <option value="elution">溶出</option>
                <option value="haze">モヤ</option>
                <option value="curl">カール</option>
                <option value="film_float">膜浮き</option>
                <option value="r1_defect">R1不良</option>
                <option value="film_ng">膜不良</option>
                <option value="foreign" selected>イブツ</option>
                <option value="cut_waste">カットくず</option>
                <option value="fiber">センイ</option>
                <option value="mold_dirt">モールド汚れ</option>
                <option value="film_dirt">膜汚れ</option>
                <option value="axis_1st">片軸</option>
                <option value="stripe_1st">脈理</option>
                <option value="edge_defect">コバスリ不良</option>
                <option value="wash_drop">洗浄落下</option>
                <option value="unknown">不明</option>
                <option value="other_1">その他1</option>
                <option value="ecc_defect">偏心不良</option>
                <option value="drop">落下</option>
                <option value="count_err">員数違い</option>
                <option value="suction">吸い込み</option>
                <option value="axis_def">軸不良</option>
                <option value="color_def">カラー不良</option>
                <option value="trans_def">透過率不良</option>
                <option value="curve_def">カーブ不良</option>
                <option value="cen_th_def">中心厚不良</option>
                <option value="diam_def">径不良</option>
                <option value="r1_th_def">R1厚み不良</option>
            </select>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <label for="date-from">R1開始日:</label>
            <input type="date" id="date-from" class="form-control">
            <button id="today-button" class="btn btn-info m-1">今日</button>
            <button id="yesterday-button" class="btn btn-info m-1">昨日</button>
            <button id="this-month-button" class="btn btn-info m-1">今月</button>
            <button id="last-month-button" class="btn btn-info m-1">前月</button>
        </div>
        <div class="col-md-6">
            <label for="date-to">R1終了日:</label>
            <input type="date" id="date-to" class="form-control">
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <label for="date-from">R2開始日:</label>
            <input type="date" id="date-from2" class="form-control">
            <button id="today-button2" class="btn btn-info m-1">今日</button>
            <button id="yesterday-button2" class="btn btn-info m-1">昨日</button>
            <button id="this-month-button2" class="btn btn-info m-1">今月</button>
            <button id="last-month-button2" class="btn btn-info m-1">前月</button>
        </div>
        <div class="col-md-6">
            <label for="date-to">R2終了日:</label>
            <input type="date" id="date-to2" class="form-control">
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="form-group">
                <label for="injector">R1注入者:</label>
                <select class="form-control" id="injector" name="injector">
                    <option value="">全ての項目</option>
                    {% for worker in workers %}
                        <option value="{{ worker.WRK_ID }}" {% if worker.WRK_ID == request.args.get('injector') %}selected{% endif %}>
                            {{ worker.WRK_NM }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="injector2">R2注入者:</label>
                <select class="form-control" id="injector2" name="injector2">
                    <option value="">全ての項目</option>
                    {% for worker in workers %}
                        <option value="{{ worker.WRK_ID }}" {% if worker.WRK_ID == request.args.get('injector') %}selected{% endif %}>
                            {{ worker.WRK_NM }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <button id="apply-filters" class="btn btn-primary">適用</button>
            <button id="reset-filters" class="btn btn-secondary">リセット</button>
        </div>
    </div>
</div>

<div class="chart-container">
    <canvas id="defect-chart"></canvas>
</div>

<div class="table-container">
    <h3>詳細データ</h3>
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="defect-table">
            <thead class="thead-dark">
                <tr>
                    <th>モノマー名</th>
                    <th>注入数</th>
                    <th>不良数</th>
                    <th>不良率(%)</th>
                </tr>
            </thead>
            <tbody>
                <!-- データはJavaScriptで動的に生成 -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // チャートの初期化
        let defectChart = null;
        
        // 日付ボタンのイベントリスナー設定
        setupDateButtons();
        
        // デフォルト値の設定と初期ロード
        setupDefaultValues();
        
        // フィルター適用
        document.getElementById('apply-filters').addEventListener('click', function() {
            fetchDefectData();
        });
        
        // フィルターリセット
        document.getElementById('reset-filters').addEventListener('click', function() {
            document.getElementById('defect-item').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-from2').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('date-to2').value = '';
            document.getElementById('injector').value = '';
            document.getElementById('injector2').value = '';
            clearChart();
            clearTable();
        });
        
        function setupDefaultValues() {
            // 現在の日付を取得
            const now = new Date();
            
          
            // デフォルトの不良項目を設定
            document.getElementById('defect-item').value = 'foreign';
            
            // 初期データを取得
            fetchDefectData();
        }
        
        function setupDateButtons() {
            // 今日ボタン
            document.getElementById('today-button').addEventListener('click', function() {
                const today = formatDateForInput(new Date());
                document.getElementById('date-from').value = today;
                document.getElementById('date-to').value = today;
            });
            
            // 昨日ボタン
            document.getElementById('yesterday-button').addEventListener('click', function() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = formatDateForInput(yesterday);
                document.getElementById('date-from').value = yesterdayStr;
                document.getElementById('date-to').value = yesterdayStr;
            });
            
            document.getElementById('this-month-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                document.getElementById('date-from').value = formatDateForInput(firstDay);
                document.getElementById('date-to').value = formatDateForInput(lastDay);
            });
        
            document.getElementById('last-month-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                const firstDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
                const lastDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
                document.getElementById('date-from').value = formatDateForInput(firstDay);
                document.getElementById('date-to').value = formatDateForInput(lastDay);
            });

            // 今日ボタン
            document.getElementById('today-button2').addEventListener('click', function() {
                const today = formatDateForInput(new Date());
                document.getElementById('date-from2').value = today;
                document.getElementById('date-to2').value = today;
            });
            
            // 昨日ボタン
            document.getElementById('yesterday-button2').addEventListener('click', function() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = formatDateForInput(yesterday);
                document.getElementById('date-from2').value = yesterdayStr;
                document.getElementById('date-to2').value = yesterdayStr;
            });
            
            document.getElementById('this-month-button2').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                document.getElementById('date-from2').value = formatDateForInput(firstDay);
                document.getElementById('date-to2').value = formatDateForInput(lastDay);
            });
        
            document.getElementById('last-month-button2').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                const firstDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
                const lastDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
                document.getElementById('date-from2').value = formatDateForInput(firstDay);
                document.getElementById('date-to2').value = formatDateForInput(lastDay);
            });
            
        }
        
        function fetchDefectData() {
            // フィルターの値を取得
            const defectItem = document.getElementById('defect-item').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const dateFrom2 = document.getElementById('date-from2').value;
            const dateTo2 = document.getElementById('date-to2').value;
            const injector = document.getElementById('injector').value;
            const injector2 = document.getElementById('injector2').value;
            

            if (!defectItem) {
                alert('不良項目を選択してください');
                return;
            }
            
            // APIリクエストURL作成
            let url = '/api/defect_by_item_data?';
            if (defectItem) url += `defect_item=${encodeURIComponent(defectItem)}&`;
            if (dateFrom) url += `date_from=${encodeURIComponent(dateFrom)}&`;
            if (dateTo) url += `date_to=${encodeURIComponent(dateTo)}&`;
            if (dateFrom2) url += `date_from2=${encodeURIComponent(dateFrom2)}&`;
            if (dateTo2) url += `date_to2=${encodeURIComponent(dateTo2)}&`;
            if (injector) url += `injector=${encodeURIComponent(injector)}&`;
            if (injector2) url += `injector2=${encodeURIComponent(injector2)}`;
            
            console.log('Fetching data from:', url);
            
            // データ取得
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || '不明なエラーが発生しました');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    if (!data.mono_syu_data || data.mono_syu_data.length === 0) {
                        document.getElementById('defect-chart').innerHTML = 
                            '<div class="alert alert-info">該当するデータがありません</div>';
                        clearTable();
                        return;
                    }
                    
                    updateChart(data);
                    updateTable(data);
                    document.getElementById('csv-import-time').textContent = '実績CSVインポート時間: ' + data.csv_import_time;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    // エラーメッセージを画面に表示
                    document.getElementById('defect-chart').innerHTML = 
                        `<div class="alert alert-danger">データの取得に失敗しました: ${error.message}</div>`;
                    clearTable();
                });
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('defect-chart').getContext('2d');
            const defectItem = document.getElementById('defect-item').value;
            
            if (defectChart) {
                defectChart.destroy();
                defectChart = null;
            }
            
            if (!data.mono_syu_data || data.mono_syu_data.length === 0) {
                return;
            }
            
            // データセット作成
            const monoSyu = data.mono_syu_data.map(item => item.mono_name);
            const defectRates = data.mono_syu_data.map(item => item.defect_rate);
            const targetRates = data.mono_syu_data.map(item => item.target || null);
            
            // バックグラウンドカラー
            const backgroundColors = root[defectItem];
            
            try {
                const selectedDefectItem = document.getElementById('defect-item');
                const defectItemText = selectedDefectItem.options[selectedDefectItem.selectedIndex].text;
                
                defectChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monoSyu,
                        datasets: [
                            {
                                label: '不良率 (%)',
                                data: defectRates,
                                backgroundColor: backgroundColors,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '不良率 (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `不良項目「${defectItemText}」のモノマー種別不良率`
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating chart:', error);
                document.getElementById('defect-chart').innerHTML = 
                    `<div class="alert alert-danger">チャートの作成に失敗しました: ${error.message}</div>`;
            }
        }
        
        function updateTable(data) {
            const tableBody = document.getElementById('defect-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            if (!data.mono_syu_data || data.mono_syu_data.length === 0) {
                return;
            }
            
            data.mono_syu_data.forEach(item => {
                const row = document.createElement('tr');
                
                // 目標値を超えている場合のクラス
                const rateClass = item.target && item.defect_rate > item.target ? 'over-target' : '';
                
                row.innerHTML = `
                    <td>${item.mono_name || 'Unknown'}</td>
                    <td>${item.total_inject.toLocaleString()}</td>
                    <td>${item.defect_count.toLocaleString()}</td>
                    <td class="${rateClass}">${item.defect_rate.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function clearChart() {
            if (defectChart) {
                defectChart.destroy();
                defectChart = null;
            }
        }
        
        function clearTable() {
            const tableBody = document.getElementById('defect-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
        }
    });
</script>
{% endblock %} 