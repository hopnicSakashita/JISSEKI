{% extends 'base.html' %}

{% block style %}
<style>
    .chart-container {
        position: relative;
        height: 600px;
        width: 100%;
        margin-bottom: 30px;
    }
    
    .table-container {
        margin-top: 30px;
        position: relative;
    }
    
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
        position: relative;
    }
    
    .defect-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .defect-table th, .defect-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: right;
    }
    
    .defect-table thead th {
        background-color: #f2f2f2;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }

    .defect-table thead th::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        border-bottom: 1px solid #ddd;
    }
    
    .defect-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .filters {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .over-target {
        color: red;
        font-weight: bold;
    }
    
    .total-row {
        background-color: #e9ecef;
        font-weight: bold;
    }
    
    .target-info {
        font-size: 0.9em;
        color: #666;
    }
    
    .period-summary {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .period-summary h3 {
        margin-bottom: 15px;
    }
    
    .period-summary table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .period-summary th, .period-summary td {
        padding: 8px;
        text-align: right;
        border: 1px solid #ddd;
    }
    
    .period-summary th {
        background-color: #f2f2f2;
        text-align: center;
    }
    
    .period-summary .total-row {
        background-color: #e9ecef;
        font-weight: bold;
    }

    .period-summary .over-target {
        color: red;
        font-weight: bold;
    }
    .table-primary th {
        border:none;
        padding: 5px 10px;
    }
</style>
{% endblock %}

{% block content %}
<h1>スピンコート種類別良品率分析</h1>

<div class="filters">
    <h3>フィルター</h3>
    <div class="row">
        <div class="col-md-6">
            <label for="date-from">コート日開始:</label>
            <input type="date" id="date-from" class="form-control">
            <button id="today-button" class="btn btn-info m-1">今日</button>
            <button id="yesterday-button" class="btn btn-info m-1">昨日</button>
            <button id="this-month-button" class="btn btn-info m-1">今月</button>
            <button id="last-month-button" class="btn btn-info m-1">前月</button>
        </div>
        <div class="col-md-6">
            <label for="date-to">コート日終了:</label>
            <input type="date" id="date-to" class="form-control">
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <button id="apply-filters" class="btn btn-primary">適用</button>
            <button id="reset-filters" class="btn btn-secondary">リセット</button>
        </div>
    </div>
</div>

<div class="mt-3">
    <h3>期間合計</h3>
    <div class="row" id="score-table">
    </div>
</div>

<div class="table-container">
    <h3>種類別詳細データ</h3>
    <div class="table-responsive">
        <table class="table table-striped table-bordered defect-table" id="spc-type-table">
            <thead class="thead-dark">
                <tr id="table-header">
                    <th>種類</th>
                    <th>目標値(%)</th>
                    <!-- 日付はJavaScriptで動的に追加 -->
                </tr>
            </thead>
            <tbody>
                <!-- データはJavaScriptで動的に生成 -->
            </tbody>
        </table>
    </div>
</div>

<div class="chart-container mt-3">
    <canvas id="spc-type-chart" style="height:500px;"></canvas>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // チャートの初期化
        let spcTypeChart = null;
        
        // SPCタイプのマッピング
        const spcTypeMap = {
            '1': '自社',
            '2': '他社',
            '3': 'NEO'
        };

        // 目標値のマッピング
        const targetMap = {
            '1': 73, // 自社
            '2': 83, // 他社
            '3': 80  // NEO
        };
        
        // フィルター適用
        document.getElementById('apply-filters').addEventListener('click', function() {
            fetchSpcTypeData();
        });
        
        // フィルターリセット
        document.getElementById('reset-filters').addEventListener('click', function() {
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            fetchSpcTypeData();
        });
        
        // 日付ボタンのイベントリスナー設定
        setupDateButtons();
        
        function setupDateButtons() {
            // 今日ボタン
            document.getElementById('today-button').addEventListener('click', function() {
                const today = new Date();
                document.getElementById('date-from').value = formatDateForInput(today);
                document.getElementById('date-to').value = formatDateForInput(today);
            });
            
            // 昨日ボタン
            document.getElementById('yesterday-button').addEventListener('click', function() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                document.getElementById('date-from').value = formatDateForInput(yesterday);
                document.getElementById('date-to').value = formatDateForInput(yesterday);
            });
            
            // 今月ボタン
            document.getElementById('this-month-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                document.getElementById('date-from').value = formatDateForInput(firstDay);
                document.getElementById('date-to').value = formatDateForInput(lastDay);
            });
            
            // 先月ボタン
            document.getElementById('last-month-button').addEventListener('click', function(e) {
                e.preventDefault();
                const now = new Date();
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                const firstDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
                const lastDay = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
                document.getElementById('date-from').value = formatDateForInput(firstDay);
                document.getElementById('date-to').value = formatDateForInput(lastDay);
            });
        }
        
        function fetchSpcTypeData() {
            // フィルターの値を取得
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            // APIリクエストURL作成
            let url = '/api/spc_type_analysis_data?';
            if (dateFrom) url += `date_from=${dateFrom}&`;
            if (dateTo) url += `date_to=${dateTo}`;
            
            // APIリクエスト
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    updateChart(data);
                    updateTable(data);
                    updateScoreTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('spc-type-chart').getContext('2d');
            
            if (spcTypeChart) {
                spcTypeChart.destroy();
            }
            
            // データセットのラベルを日本語に変換し、良品率に変換
            const updatedDatasets = data.datasets.map(dataset => {
                const typeCode = dataset.label.replace('種類: ', '');
                const jaLabel = spcTypeMap[typeCode] || '合計';
                
                // データポイントを良品率に変換
                const goodRateData = dataset.data.map(rate => {
                    return (rate !== null && rate !== undefined) ? 100 - rate : null;
                });
                
                return {
                    ...dataset,
                    label: jaLabel,
                    data: goodRateData
                };
            });
            
            spcTypeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels.map(date => {
                        const d = new Date(date);
                        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                        return `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}(${weekdays[d.getDay()]})`
                    }),
                    datasets: updatedDatasets
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'スピンコート種類別の良品率推移',
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'start',
                            align: 'start',
                            font: {
                                size: 14
                            },
                            formatter: function(value, context) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 100,
                            title: {
                                display: true,
                                text: '良品率 (%)',
                                font: {
                                    size: 16
                                }
                            },
                            ticks: {
                                font: {
                                    size: 16
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'コート日',
                                font: {
                                    size: 16
                                }
                            },
                            ticks: {
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateTable(data) {
            const tableHeader = document.getElementById('table-header');
            while (tableHeader.childElementCount > 2) {
                tableHeader.removeChild(tableHeader.lastChild);
            }
            
            data.labels.forEach(date => {
                const th = document.createElement('th');
                const dateObj = new Date(date);
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const day = dateObj.getDate().toString().padStart(2, '0');
                th.textContent = `${month}/${day}`;
                tableHeader.appendChild(th);
            });
            
            const tableBody = document.getElementById('spc-type-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            data.spc_types.forEach(type => {
                const row = document.createElement('tr');
                
                // 種類列
                const typeCell = document.createElement('td');
                typeCell.textContent = spcTypeMap[type] || '不明';
                row.appendChild(typeCell);
                
                // 目標値列
                const targetCell = document.createElement('td');
                const target = targetMap[type];
                targetCell.textContent = target ? target.toFixed(1) : '-';
                row.appendChild(targetCell);
                
                // 日付ごとの良品率
                data.labels.forEach(date => {
                    const cell = document.createElement('td');
                    if (data.spc_type_data[type] && data.spc_type_data[type][date]) {
                        const defectRate = data.spc_type_data[type][date].defect_rate;
                        const goodRate = 100 - defectRate;
                        cell.textContent = goodRate.toFixed(2) + '%';
                        
                        if (target && goodRate < target) {
                            cell.classList.add('over-target');
                        }
                    } else {
                        cell.textContent = '-';
                    }
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
            
            // 合計行
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = '合計';
            totalRow.appendChild(totalLabelCell);
            
            const totalTargetCell = document.createElement('td');
            totalTargetCell.textContent = '-';
            totalRow.appendChild(totalTargetCell);
            
            data.labels.forEach(date => {
                const cell = document.createElement('td');
                const defectRate = data.total_rates[date];
                if (defectRate !== undefined && defectRate !== null) {
                    const goodRate = 100 - defectRate;
                    cell.textContent = goodRate.toFixed(2) + '%';
                } else {
                    cell.textContent = '-';
                }
                totalRow.appendChild(cell);
            });
            
            tableBody.appendChild(totalRow);
        }

        function updateScoreTable(data) {
            const scoreDiv = document.getElementById('score-table');
            scoreDiv.innerHTML = '';
            scoreDiv.classList.add('row');
            
            data.spc_types.forEach(type => {
                const col = document.createElement('div');
                col.classList.add('col-md-4');

                const tableBody = document.createElement('table');
                tableBody.classList.add('table');

                const thead = document.createElement('thead');
                thead.classList.add('table-primary');
                const tr1 = document.createElement('tr');
                const th1 = document.createElement('th');
                th1.colSpan = 3;
                th1.textContent = spcTypeMap[type] || '不明';
                tr1.appendChild(th1);
                thead.appendChild(tr1);
                
                const tbody = document.createElement('tbody');
                const tr2 = document.createElement('tr');
                const td1 = document.createElement('td');
                td1.textContent = '目標値';
                td1.classList.add('text-left');
                tr2.appendChild(td1);
                const td2 = document.createElement('td');
                td2.textContent = '良品率';
                td2.classList.add('text-left');
                tr2.appendChild(td2);
                const td3 = document.createElement('td');
                td3.textContent = '差分';
                td3.classList.add('text-left');
                tr2.appendChild(td3);
                tbody.appendChild(tr2);
                
                const tr3 = document.createElement('tr');
                const targetCell = document.createElement('td');
                targetCell.classList.add('text-right', 'align-bottom');
                const target = targetMap[type];
                const targetSpan = document.createElement('span');
                targetSpan.classList.add('text-right', 'h3', 'font-weight-bold', 'fst-italic');
                targetSpan.textContent = target ? target.toFixed(1) : '-';
                targetCell.appendChild(targetSpan);
                const targetPercent = document.createElement('span');
                targetPercent.classList.add('text-right');
                targetPercent.textContent = '%';
                targetCell.appendChild(targetPercent);
                tr3.appendChild(targetCell);
                
                const rateCell = document.createElement('td');
                rateCell.classList.add('text-right', 'align-bottom');
                const differenceCell = document.createElement('td');
                differenceCell.classList.add('text-right', 'align-bottom');
                
                const defectRate = data.period_total_rates[type]['defect_rate'];
                const total = data.period_total_rates[type]['total'];
                if (total !== undefined && total !== null && total > 0 && defectRate !== undefined && defectRate !== null) {
                    const goodRate = 100 - defectRate;
                    const difference = goodRate - target;
                    
                    const rateSpan = document.createElement('span');
                    rateSpan.classList.add('text-right', 'h2', 'font-weight-bold', 'fst-italic');
                    rateSpan.classList.add(goodRate < target ? 'text-danger' : 'text-primary');
                    rateSpan.textContent = goodRate.toFixed(2);
                    rateCell.appendChild(rateSpan);
                    
                    const ratePercent = document.createElement('span');
                    ratePercent.classList.add('text-right');
                    ratePercent.textContent = '%';
                    rateCell.appendChild(ratePercent);
                    
                    const differenceSpan = document.createElement('span');
                    differenceSpan.classList.add('text-right', 'h4', 'font-weight-bold');
                    differenceSpan.classList.add(difference < 0 ? 'text-danger' : 'text-primary');
                    differenceSpan.textContent = difference.toFixed(2);
                    differenceCell.appendChild(differenceSpan);
                    
                    const differencePercent = document.createElement('span');
                    differencePercent.classList.add('text-right');
                    differencePercent.textContent = '%';
                    differenceCell.appendChild(differencePercent);
                } else {
                    const rateSpan = document.createElement('span');
                    rateSpan.classList.add('text-right');
                    rateSpan.textContent = '-';
                    rateCell.appendChild(rateSpan);
                    
                    const ratePercent = document.createElement('span');
                    ratePercent.classList.add('text-right');
                    ratePercent.textContent = '%';
                    rateCell.appendChild(ratePercent);
                    
                    const differenceSpan = document.createElement('span');
                    differenceSpan.classList.add('text-right');
                    differenceSpan.textContent = '-';
                    differenceCell.appendChild(differenceSpan);
                    
                    const differencePercent = document.createElement('span');
                    differencePercent.classList.add('text-right');
                    differencePercent.textContent = '%';
                    differenceCell.appendChild(differencePercent);
                }
                
                tr3.appendChild(rateCell);
                tr3.appendChild(differenceCell);
                tbody.appendChild(tr3);

                const tr4 = document.createElement('tr');
                const td4 = document.createElement('td');
                td4.textContent = '投入数';
                td4.classList.add('text-left');
                tr4.appendChild(td4);
                const td5 = document.createElement('td');
                td5.textContent = total;
                td5.colSpan = 2;
                td5.classList.add('text-right');
                tr4.appendChild(td5);
                tbody.appendChild(tr4);
                
                tableBody.appendChild(thead);
                tableBody.appendChild(tbody);
                
                col.appendChild(tableBody);
                scoreDiv.appendChild(col);
            });
        }
        
        // 初期データ取得
        fetchSpcTypeData();
    });
</script>
{% endblock %} 